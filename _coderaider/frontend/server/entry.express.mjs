import oe,{Headers as se,Request as re,Response as ie}from"node-fetch";import{getNotFound as ae}from"./@qwik-city-not-found-paths.js";import ce from"./@qwik-city-plan.mjs";import le from"./entry.ssr.mjs";import B from"express";import{fileURLToPath as fe}from"node:url";import{join as z}from"node:path";import de from"compression";import"@builder.io/qwik";import"@builder.io/qwik/jsx-runtime";import"./assets/root-7ec1d247.mjs";import"@supabase/supabase-js";import"dotenv";import"@builder.io/qwik/server";var _={lax:"Lax",none:"None",strict:"Strict"},ue={seconds:1,minutes:1*60,hours:1*60*60,days:1*60*60*24,weeks:1*60*60*24*7},he=(e,t,n)=>{const o=[`${e}=${t}`];return typeof n.domain=="string"&&o.push(`Domain=${n.domain}`),typeof n.maxAge=="number"?o.push(`Max-Age=${n.maxAge}`):Array.isArray(n.maxAge)?o.push(`Max-Age=${n.maxAge[0]*ue[n.maxAge[1]]}`):typeof n.expires=="number"||typeof n.expires=="string"?o.push(`Expires=${n.expires}`):n.expires instanceof Date&&o.push(`Expires=${n.expires.toUTCString()}`),n.httpOnly&&o.push("HttpOnly"),typeof n.path=="string"&&o.push(`Path=${n.path}`),n.sameSite&&_[n.sameSite]&&o.push(`SameSite=${_[n.sameSite]}`),n.secure&&o.push("Secure"),o.join("; ")},pe=e=>{const t={};if(typeof e=="string"&&e!==""){const n=e.split(";");for(const o of n){const s=o.split("=");if(s.length>1){const i=decodeURIComponent(s[0].trim()),r=decodeURIComponent(s[1].trim());t[i]=r}}}return t},C=Symbol("request-cookies"),N=Symbol("response-cookies"),G,T=class{constructor(e){this[G]={},this[C]=pe(e)}get(e){const t=this[C][e];return t?{value:t,json(){return JSON.parse(t)},number(){return Number(t)}}:null}has(e){return!!this[C][e]}set(e,t,n={}){const o=typeof t=="string"?t:encodeURIComponent(JSON.stringify(t));this[N][e]=he(e,o,n)}delete(e,t){this.set(e,"deleted",{...t,maxAge:0})}headers(){return Object.values(this[N])}};G=N;var m=Symbol("headers"),I,ye=class{constructor(){this[I]={}}[(I=m,Symbol.iterator)](){return this.entries()}*keys(){for(const e of Object.keys(this[m]))yield e}*values(){for(const e of Object.values(this[m]))yield e}*entries(){for(const e of Object.keys(this[m]))yield[e,this.get(e)]}get(e){return this[m][E(e)]||null}set(e,t){const n=E(e);this[m][n]=typeof t!="string"?String(t):t}append(e,t){const n=E(e),o=this.has(n)?`${this.get(n)}, ${t}`:t;this.set(e,o)}delete(e){if(!this.has(e))return;const t=E(e);delete this[m][t]}all(){return this[m]}has(e){return this[m].hasOwnProperty(E(e))}forEach(e,t){for(const n in this[m])this[m].hasOwnProperty(n)&&e.call(t,this[m][n],n,this)}},me=/[^a-z0-9\-#$%&'*+.^_`|~]/i;function E(e){if(typeof e!="string"&&(e=String(e)),me.test(e)||e.trim()==="")throw new TypeError("Invalid character in header field name");return e.toLowerCase()}function A(){return new(typeof Headers=="function"?Headers:ye)}var O=class extends Error{constructor(e,t){super(t),this.status=e}};function V(e,t){const o=Q(500,t),s=A();return s.set("Content-Type","text/html; charset=utf-8"),e.response(500,s,new T,async i=>{i.write(o)},t)}function ge(e,t){const n=K(t.status,t.message,t.stack),o=A();return o.set("Content-Type","text/html; charset=utf-8"),e.response(t.status,o,new T,async s=>{s.write(n)},t)}function Q(e,t){let n="Server Error",o;return t!=null&&(typeof t=="object"?(typeof t.message=="string"&&(n=t.message),t.stack!=null&&(o=String(t.stack))):n=String(t)),K(e,n,o)}function K(e,t,n){const o=typeof t=="string"?"600px":"300px",s=e>=500?be:we;return e<500&&(n=""),`<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="Status" content="${e}"/>
  <title>${e} ${t}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { color: ${s}; background-color: #fafafa; padding: 30px; font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, Roboto, sans-serif; }
    p { max-width: ${o}; margin: 60px auto 30px auto; background: white; border-radius: 4px; box-shadow: 0px 0px 50px -20px ${s}; overflow: hidden; }
    strong { display: inline-block; padding: 15px; background: ${s}; color: white; }
    span { display: inline-block; padding: 15px; }
    pre { max-width: 580px; margin: 0 auto; }
  </style>
</head>
<body>
  <p><strong>${e}</strong> <span>${t}</span></p>${n?`
  <pre><code>${n}</code></pre>`:""}
</body>
</html>`}var we="#006ce9",be="#713fc2";function ve(e,t){const{pendingBody:n,resolvedBody:o,status:s,headers:i,cookie:r}=t,{response:l}=e;if(n===void 0&&o===void 0)return l(s,i,r,Se);i.has("Content-Type")||i.set("Content-Type","application/json; charset=utf-8");const a=i.get("Content-Type").includes("json");return l(s,i,r,async({write:c})=>{const d=n!==void 0?await n:o;if(d!==void 0)if(a)c(JSON.stringify(d));else{const u=typeof d;c(u==="string"?d:u==="number"||u==="boolean"?String(d):d)}})}var Se=async()=>{},R=class{constructor(e,t,n,o){this.url=e,this.location=e,this.status=X(t)?t:302,this.headers=n??A(),this.headers.set("Location",this.location),this.headers.delete("Cache-Control"),this.cookies=o??new T}};function ke(e,t){return e.response(t.status,t.headers,t.cookies,async()=>{})}function X(e){return typeof e=="number"&&e>=301&&e<=308}function xe(e){if(JSON.stringify(e),!$(e))throw new Error("Unable to serialize value.")}function $(e){if(e==null||typeof e=="string"||typeof e=="boolean"||typeof e=="number")return!0;if(Array.isArray(e)){for(const t of e)if(!$(t))return!1;return!0}if(e.constructor==null||e.constructor===Object){for(const t in e)if(!$(e[t]))return!1;return!0}return!1}async function Ee(e,t,n,o,s="/"){if(n.length===0)throw new O(404,"Not Found");const{request:i,url:r,platform:l}=e,{pathname:a}=r,{method:c,headers:d}=i,u=Oe(n),h=u&&a.endsWith(D),p=!h&&Ae(c,d.get("Accept"),d.get("Content-Type")),w=new T(d.get("cookie")),f={type:h?"pagedata":u&&!p?"pagehtml":"endpoint",url:r,params:t,status:200,headers:A(),resolvedBody:void 0,pendingBody:void 0,cookie:w,aborted:!1};let P=!1;if(u&&!h&&a!==s&&!a.endsWith(".html")){if(o){if(!a.endsWith("/"))throw new R(a+"/"+r.search,302)}else if(a.endsWith("/"))throw new R(a.slice(0,a.length-1)+r.search,302)}let b=-1;const Z=()=>{b=U},j=async()=>{for(b++;b<n.length;){const g=n[b];let y;switch(c){case"GET":{y=g.onGet;break}case"POST":{y=g.onPost;break}case"PUT":{y=g.onPut;break}case"PATCH":{y=g.onPatch;break}case"DELETE":{y=g.onDelete;break}case"OPTIONS":{y=g.onOptions;break}case"HEAD":{y=g.onHead;break}}if(y=y||g.onRequest,typeof y=="function"){P=!0;const ee=new Re(f,e),te={request:i,url:new URL(r),params:{...t},response:ee,platform:l,cookie:w,next:j,abort:Z},v=y(te);if(typeof v=="function")f.pendingBody=L(v);else if(v!==null&&typeof v=="object"&&typeof v.then=="function"){const x=await v;typeof x=="function"?f.pendingBody=L(x):f.resolvedBody=x}else f.resolvedBody=v;if(e.mode==="dev"){const x=f.resolvedBody!=null?f.resolvedBody:f.pendingBody!=null?await f.pendingBody:null;try{xe(x)}catch(ne){throw Object.assign(ne,{id:"DEV_SERIALIZE",endpointModule:g,requestHandler:y,method:c})}}}b++}};if(await j(),f.aborted=b>=U,!h&&X(f.status)&&f.headers.has("Location"))throw new R(f.headers.get("Location"),f.status,f.headers,f.cookie);if(P)u&&c==="GET"&&(f.headers.has("Vary")||f.headers.set("Vary","Content-Type, Accept"));else if(p&&!h||!u)throw new O(405,"Method Not Allowed");return f}var S=Symbol("UserResponse"),H=Symbol("RequestContext"),Re=class{constructor(e,t){this[S]=e,this[H]=t}get status(){return this[S].status}set status(e){this[S].status=e}get headers(){return this[S].headers}get locale(){return this[H].locale}set locale(e){this[H].locale=e}redirect(e,t){return new R(e,t,this[S].headers,this[S].cookie)}error(e,t){return new O(e,t)}};function Ae(e,t,n){if(e==="GET"||e==="POST"){if(n&&n.includes("application/json"))return!0;if(t){const o=t.indexOf("text/html");if(o===0)return!1;const s=t.indexOf("application/json");if(s>-1)return o>-1?s<o:!0}return!1}else return!0}function L(e){return new Promise((t,n)=>{try{const o=e();o!==null&&typeof o=="object"&&typeof o.then=="function"?o.then(t,n):t(o)}catch(o){n(o)}})}function Oe(e){const t=e[e.length-1];return t&&typeof t.default=="function"}function Te(e,t){if(e.endsWith(D)){const n=e.length-Pe+(t?1:0);e=e.slice(0,n),e===""&&(e="/")}return e}var D="/q-data.json",Pe=D.length,U=999999999,q=new WeakMap,Ce=async(e,t,n,o)=>{if(Array.isArray(e))for(const s of e){const i=s[0].exec(o);if(i){const r=s[1],l=Ne(s[2],i),a=s[4],c=new Array(r.length),d=[],u=He(t,o);let h;return r.forEach((p,w)=>{M(p,d,f=>c[w]=f,n)}),M(u,d,p=>h=p==null?void 0:p.default,n),d.length>0&&await Promise.all(d),[l,c,h,a]}}return null},M=(e,t,n,o)=>{if(typeof e=="function"){const s=q.get(e);if(s)n(s);else{const i=e();typeof i.then=="function"?t.push(i.then(r=>{o!==!1&&q.set(e,r),n(r)})):i&&n(i)}}},He=(e,t)=>{if(e){t=t.endsWith("/")?t:t+"/";const n=e.find(o=>o[0]===t||t.startsWith(o[0]+(t.endsWith("/")?"":"/")));if(n)return n[1]}},Ne=(e,t)=>{const n={};if(e)for(let o=0;o<e.length;o++)n[e[o]]=t?t[o+1]:"";return n};function $e(e,t,n,o,s){const{status:i,headers:r,cookie:l}=t,{response:a}=e,c=t.type==="pagedata",d={};return e.request.headers.forEach((u,h)=>d[h]=u),c?r.set("Content-Type","application/json; charset=utf-8"):r.has("Content-Type")||r.set("Content-Type","text/html; charset=utf-8"),a(c?200:i,r,l,async u=>{try{const h=await n({stream:c?je:u,envData:De(d,t,e.locale,e.mode),...o});c?u.write(JSON.stringify(await F(t,h,s))):(typeof h).html==="string"&&u.write(h.html),typeof u.clientData=="function"&&u.clientData(await F(t,h,s))}catch(h){const p=Q(500,h);u.write(p)}})}async function F(e,t,n){const o=Be(t,n),s=t.isStatic;return{body:e.pendingBody?await e.pendingBody:e.resolvedBody,status:e.status!==200?e.status:void 0,redirect:e.status>=301&&e.status<=308&&e.headers.get("location")||void 0,isStatic:s,prefetch:o.length>0?o:void 0}}function Be(e,t){const n=[],o=l=>{l&&!n.includes(l)&&n.push(l)},s=l=>{if(Array.isArray(l))for(const a of l){const c=a.url.split("/").pop();c&&!n.includes(c)&&(o(c),s(a.imports))}};s(e.prefetchResources);const i=e.manifest||e._manifest,r=e._symbols;if(i&&r)for(const l of r){const a=i.symbols[l];a&&a.ctxName==="component$"&&o(i.mapping[l])}if(t)for(const l of t)o(l);return n}function De(e,t,n,o){const{url:s,params:i,pendingBody:r,resolvedBody:l,status:a}=t;return{url:s.href,requestHeaders:e,locale:n,qwikcity:{mode:o,params:{...i},response:{body:r||l,status:a}}}}var je={write:()=>{}};async function _e(e,t){try{const{render:n,qwikCityPlan:o}=t,{routes:s,menus:i,cacheModules:r,trailingSlash:l,basePathname:a}=o,c=Te(e.url.pathname,l),d=await Ce(s,i,r,c);if(d){const[u,h,p,w]=d,f=await Ee(e,u,h,l,a);return f.aborted?null:f.type==="endpoint"?await ve(e,f):await $e(e,f,n,t,w)}}catch(n){return n instanceof R?ke(e,n):n instanceof O?ge(e,n):V(e,n)}return null}function J(e){const t=e.socket.encrypted||e.connection.encrypted?"https":"http";return new URL(e.url||"/",`${t}://${e.headers.host}`)}function Ie(e,t,n,o){const s=A(),i=t.headers;for(const a in i){const c=i[a];if(typeof c=="string")s.set(a,c);else if(Array.isArray(c))for(const d of c)s.append(a,d)}const r=async()=>{const a=[];for await(const c of t)a.push(c);return Buffer.concat(a).toString()};return{mode:o,request:{headers:s,formData:async()=>new URLSearchParams(await r()),json:async()=>JSON.parse(await r()),method:t.method||"GET",text:r,url:e.href},response:async(a,c,d,u)=>{n.statusCode=a,c.forEach((p,w)=>n.setHeader(w,p));const h=d.headers();return h.length>0&&n.setHeader("Set-Cookie",h),u({write:p=>{n.write(p)}}).finally(()=>{n.end()}),n},url:e,platform:{ssr:!0,node:process.versions.node},locale:void 0}}function Le(){typeof global<"u"&&typeof globalThis.fetch!="function"&&typeof process<"u"&&process.versions.node&&(globalThis.fetch||(globalThis.fetch=oe,globalThis.Headers=se,globalThis.Request=re,globalThis.Response=ie))}function Ue(e){return Le(),{router:async(o,s,i)=>{try{const r=Ie(J(o),o,s,"server");try{await _e(r,e)||i()}catch(l){await V(r,l)}}catch(r){console.error(r),i(r)}},notFound:async(o,s,i)=>{try{const r=J(o),l=ae(r.pathname);s.writeHead(404,{"Content-Type":"text/html; charset=utf-8","X-Not-Found":r.pathname}),s.end(l)}catch(r){console.error(r),i(r)}}}}const Y=z(fe(import.meta.url),"..","..","dist"),qe=z(Y,"build"),W=process.env.PORT??3e3,{router:Me,notFound:Fe}=Ue({render:le,qwikCityPlan:ce}),k=B();k.use(de());k.use("/build",B.static(qe,{immutable:!0,maxAge:"1y"}));k.use(B.static(Y,{redirect:!1}));k.use(Me);k.use(Fe);k.listen(W,()=>{console.log(`Server starter: http://localhost:${W}/`)});
